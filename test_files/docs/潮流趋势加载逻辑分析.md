# æ½®æµè¶‹åŠ¿åŠ è½½é€»è¾‘åˆ†æ

## ğŸ“Š æ•°æ®æ¥æºå’Œè·å–æ–¹å¼

### 1. æ•°æ®æºæ¶æ„
æ½®æµè¶‹åŠ¿æ•°æ®é‡‡ç”¨**åŒé‡æ•°æ®æº**ç­–ç•¥ï¼š
- **ä¸»æ•°æ®æº**: Last.fm API (`chart.gettoptracks` æ–¹æ³•)
- **å¤‡ç”¨æ•°æ®æº**: æœ¬åœ° FALLBACK_RECORDS é™æ€æ•°æ®

### 2. æ•°æ®è·å–æµç¨‹
```typescript
// ä½ç½®: MusicApiService.ets -> getTrendingRecords()
async getTrendingRecords(): Promise<ApiResponse<ApiRecordItem>> {
  try {
    // 1. å°è¯•è°ƒç”¨ Last.fm API
    const params = {
      method: 'chart.gettoptracks',
      api_key: this.LASTFM_API_KEY,
      format: 'json',
      limit: '10'
    };
    const response = await this.fetchFromLastFm(params);
    
    // 2. å¦‚æœAPIæˆåŠŸï¼Œè§£æå¹¶è¿”å›æ•°æ®
    if (response?.success && response.data) {
      return { success: true, data: this.parseTracksResponse(response.data) };
    }
  } catch (error) {
    console.error('è·å–çƒ­é—¨å”±ç‰‡å¤±è´¥:', error);
  }
  
  // 3. APIå¤±è´¥æ—¶ï¼Œè¿”å›å¤‡ç”¨æ•°æ®
  return { success: true, data: this.FALLBACK_RECORDS };
}
```

### 3. å¤‡ç”¨æ•°æ®ç»“æ„
```typescript
// ä½ç½®: MusicApiService.ets -> FALLBACK_RECORDS
private readonly FALLBACK_RECORDS: ApiRecordItem[] = [
  {
    id: '249504',           // Discogs release ID
    title: 'After Hours',   // å”±ç‰‡æ ‡é¢˜
    artist: 'The Weeknd',   // è‰ºæœ¯å®¶
    image: 'https://i.scdn.co/image/...',  // Spotify å›¾ç‰‡URL
    year: 2020,
    genres: ['Pop', 'Synthwave'],
    playcount: 1500000
  },
  // ... æ›´å¤šå”±ç‰‡æ•°æ®
];
```

## ğŸ”„ åŠ è½½é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†

### 1. ç»„ä»¶çŠ¶æ€å®šä¹‰
```typescript
// ä½ç½®: Index.ets
@State private trendingRecords: ApiRecordItem[] = [];      // å”±ç‰‡æ•°æ®
@State private isLoadingRecords: boolean = true;          // åŠ è½½çŠ¶æ€
@State private recordsError: string = '';                 // é”™è¯¯ä¿¡æ¯
@State private failedImages: Set<string> = new Set();     // å¤±è´¥å›¾ç‰‡è®°å½•
```

### 2. åŠ è½½æ—¶æœº
- **ç»„ä»¶åˆå§‹åŒ–**: `aboutToAppear()` ç”Ÿå‘½å‘¨æœŸä¸­è‡ªåŠ¨åŠ è½½
- **ç”¨æˆ·é‡è¯•**: é”™è¯¯çŠ¶æ€ä¸‹ç‚¹å‡»"é‡è¯•"æŒ‰é’®è§¦å‘

### 3. åŠ è½½æµç¨‹
```typescript
// ä½ç½®: Index.ets -> loadTrendingRecords()
private async loadTrendingRecords(): Promise<void> {
  try {
    this.isLoadingRecords = true;     // 1. è®¾ç½®åŠ è½½çŠ¶æ€
    this.recordsError = '';           // 2. æ¸…ç©ºé”™è¯¯ä¿¡æ¯
    
    // 3. è°ƒç”¨APIæœåŠ¡
    const response = await this.musicApiService.getTrendingRecords();
    
    // 4. å¤„ç†å“åº”
    if (response?.success && response.data) {
      this.trendingRecords = response.data;  // æˆåŠŸï¼šæ›´æ–°æ•°æ®
    } else {
      this.recordsError = response?.error || 'åŠ è½½å¤±è´¥';  // å¤±è´¥ï¼šè®¾ç½®é”™è¯¯
    }
  } catch (error) {
    console.error('åŠ è½½çƒ­é—¨å”±ç‰‡å¤±è´¥:', error);
    this.recordsError = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
  } finally {
    this.isLoadingRecords = false;    // 5. é‡ç½®åŠ è½½çŠ¶æ€
  }
}
```

## ğŸ¨ UIå±•ç¤ºé€»è¾‘

### 1. ä¸‰ç§UIçŠ¶æ€
æ½®æµè¶‹åŠ¿åŒºåŸŸæ ¹æ®åŠ è½½çŠ¶æ€å±•ç¤ºä¸åŒå†…å®¹ï¼š

#### åŠ è½½ä¸­çŠ¶æ€ (`isLoadingRecords = true`)
```typescript
Row() {
  LoadingProgress().width(24).height(24).color(this.textSecondary)
  Text('æ­£åœ¨åŠ è½½çƒ­é—¨å”±ç‰‡...').fontSize(14).fontColor(this.textSecondary)
}
```

#### é”™è¯¯çŠ¶æ€ (`recordsError` ä¸ä¸ºç©º)
```typescript
Column({ space: 8 }) {
  Text('ğŸ˜”').fontSize(24)
  Text(this.recordsError).fontSize(14).fontColor(this.textSecondary)
  Button('é‡è¯•').onClick(() => { this.loadTrendingRecords(); })
}
```

#### æ•°æ®å±•ç¤ºçŠ¶æ€ (æ­£å¸¸åŠ è½½å®Œæˆ)
```typescript
Scroll() {
  Row({ space: 16 }) {
    ForEach(this.trendingRecords, (record: ApiRecordItem, index: number) => {
      // å”±ç‰‡å¡ç‰‡å±•ç¤º
    })
  }
}
```

### 2. å›¾ç‰‡å¤„ç†ç­–ç•¥
é‡‡ç”¨**æ¸è¿›å¼å›¾ç‰‡åŠ è½½**ç­–ç•¥ï¼š

```typescript
// 1. ä¼˜å…ˆæ˜¾ç¤ºçœŸå®å›¾ç‰‡
if (this.isValidImageUrl(record.image) && !this.failedImages.has(record.image)) {
  Image(record.image)
    .onError(() => {
      // 2. å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶è®°å½•å¹¶åˆ‡æ¢åˆ°å ä½ç¬¦
      this.failedImages.add(record.image);
    })
} else {
  // 3. æ˜¾ç¤ºæ¸å˜è‰²å ä½ç¬¦
  this.RecordPlaceholder(record, index, 144, 144)
}
```

### 3. å ä½ç¬¦ç»„ä»¶
```typescript
@Builder
private RecordPlaceholder(record: ApiRecordItem, index: number, width: number, height: number) {
  Stack() {
    // æ¸å˜èƒŒæ™¯ (10ç§é¢œè‰²å¾ªç¯)
    Row() {}.linearGradient({
      angle: 45,
      colors: [
        [this.getGradientColors(index)[0], 0.0],
        [this.getGradientColors(index)[1], 1.0]
      ]
    })
    
    // å”±ç‰‡ä¿¡æ¯æ–‡å­—
    Column({ space: 4 }) {
      Text(record.title).fontSize(14).fontWeight(FontWeight.Bold)
      Text(record.artist).fontSize(12).fontColor('#E0E0E0')
    }
  }
}
```

## ğŸŒ APIè°ƒç”¨æµç¨‹

### 1. Last.fm APIè°ƒç”¨é“¾è·¯
```
Index.ets -> MusicApiService.getTrendingRecords()
    â†“
MusicApiService.fetchFromLastFm()
    â†“
HTTPè¯·æ±‚: https://ws.audioscrobbler.com/2.0/?method=chart.gettoptracks&api_key=demo_key&format=json&limit=10
    â†“
MusicApiService.parseTracksResponse() // æ•°æ®è§£æ
    â†“
è¿”å› ApiResponse<ApiRecordItem[]>
```

### 2. APIå‚æ•°é…ç½®
```typescript
// ä½ç½®: MusicApiService.ets
private readonly LASTFM_API_KEY: string = 'demo_key';
private readonly LASTFM_BASE_URL: string = 'https://ws.audioscrobbler.com/2.0/';

// è¯·æ±‚å‚æ•°
const params: LastFmRequestParams = {
  method: 'chart.gettoptracks',  // è·å–çƒ­é—¨æ›²ç›®
  api_key: this.LASTFM_API_KEY,  // APIå¯†é’¥
  format: 'json',                // å“åº”æ ¼å¼
  limit: '10'                    // æ•°æ®æ¡æ•°
};
```

### 3. æ•°æ®è§£æé€»è¾‘
```typescript
// ä½ç½®: MusicApiService.ets -> parseTracksResponse()
private parseTracksResponse(data: Record<string, ESObject>): ApiRecordItem[] {
  const tracks: ESObject[] = (data?.tracks?.track as ESObject[]) || [];
  
  return tracks.slice(0, 5).map((track: ESObject, index: number) => {
    return {
      id: (track.mbid as string) || generateNumericId(trackName, artistName, index),
      title: (track.name as string) || 'æœªçŸ¥ä¸“è¾‘',
      artist: ((track.artist as ESObject)?.name as string) || 'æœªçŸ¥è‰ºæœ¯å®¶',
      image: this.extractImageUrl(track.image as ESObject[]) || '',
      playcount: parseInt((track.playcount as string) || '0') || 0,
      listeners: parseInt((track.listeners as string) || '0') || 0,
      url: (track.url as string) || undefined
    };
  });
}
```

### 4. å›¾ç‰‡URLæå–
```typescript
// ä½ç½®: MusicApiService.ets -> extractImageUrl()
private extractImageUrl(images: ESObject[] | undefined): string {
  if (!images || !Array.isArray(images)) return '';
  
  // 1. ä¼˜å…ˆé€‰æ‹©å¤§å°ºå¯¸å›¾ç‰‡
  const largeImage = images.find(img => 
    img.size === 'extralarge' || img.size === 'large'
  );
  
  if (largeImage?.['#text']) {
    const imageUrl = largeImage['#text'] as string;
    // 2. è¿‡æ»¤Last.fmå ä½ç¬¦å›¾ç‰‡
    if (imageUrl && !imageUrl.includes('2a96cbd8b46e442fc41c2b86b821562f')) {
      return imageUrl;
    }
  }
  
  // 3. å¤‡é€‰å›¾ç‰‡ï¼ˆæ’é™¤å ä½ç¬¦ï¼‰
  const fallbackImage = images.find(img => {
    const url = img['#text'] as string;
    return Boolean(url) && !url.includes('2a96cbd8b46e442fc41c2b86b821562f');
  });
  
  return (fallbackImage?.['#text'] as string) || '';
}
```

## ğŸ”§ å…³é”®æŠ€æœ¯ç‰¹æ€§

### 1. ç©ºå€¼å®‰å…¨å¤„ç†
- ä½¿ç”¨å¯é€‰é“¾æ“ä½œç¬¦ `?.` å’Œç©ºå€¼åˆå¹¶æ“ä½œç¬¦ `??`
- æ‰€æœ‰APIå“åº”éƒ½è¿›è¡Œä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥
- å›¾ç‰‡åŠ è½½å¤±è´¥æ—¶çš„ä¼˜é›…é™çº§

### 2. é”™è¯¯å¤„ç†æœºåˆ¶
- APIè°ƒç”¨å¤±è´¥è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®
- å›¾ç‰‡åŠ è½½å¤±è´¥è‡ªåŠ¨æ˜¾ç¤ºå ä½ç¬¦
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¯•åŠŸèƒ½

### 3. æ€§èƒ½ä¼˜åŒ–
- å›¾ç‰‡æ‡’åŠ è½½å’Œé”™è¯¯ç¼“å­˜
- æ¸å˜è‰²å ä½ç¬¦å‡å°‘ç½‘ç»œè¯·æ±‚
- æ•°æ®é™åˆ¶ï¼ˆæœ€å¤šæ˜¾ç¤º5æ¡è®°å½•ï¼‰

### 4. ç”¨æˆ·ä½“éªŒ
- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
- å¹³æ»‘çš„æ°´å¹³æ»šåŠ¨
- ç‚¹å‡»åé¦ˆå’Œå¯¼èˆª
- å“åº”å¼å¸ƒå±€è®¾è®¡

## ğŸ“ æ€»ç»“

æ½®æµè¶‹åŠ¿åŠŸèƒ½é‡‡ç”¨äº†å®Œæ•´çš„**æ•°æ®è·å– â†’ çŠ¶æ€ç®¡ç† â†’ UIå±•ç¤º**æ¶æ„ï¼Œå…·å¤‡ï¼š
- âœ… åŒé‡æ•°æ®æºä¿è¯å¯ç”¨æ€§
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶  
- âœ… ä¼˜é›…çš„åŠ è½½çŠ¶æ€ç®¡ç†
- âœ… æ¸è¿›å¼å›¾ç‰‡åŠ è½½ç­–ç•¥
- âœ… ç”¨æˆ·å‹å¥½çš„äº¤äº’ä½“éªŒ

æ•´ä¸ªç³»ç»Ÿè®¾è®¡å¥å£®ï¼Œèƒ½å¤Ÿåœ¨å„ç§ç½‘ç»œç¯å¢ƒä¸‹ç¨³å®šè¿è¡Œã€‚