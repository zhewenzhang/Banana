import router from '@ohos.router';
import { ApiRecordItem, ApiArtistItem, MusicApiService } from '../services/MusicApiService';

// ä¿ç•™åŸæœ‰æ¥å£ä½œä¸ºå…¼å®¹
interface RecordItem {
  title: string;
  artist: string;
  image: string;
}

interface ArtistItem {
  name: string;
  image: string;
}

@Entry
@Component
struct Index {
  @State searchText: string = '';
  @State private currentTab: number = 0;
  @State private trendingRecords: ApiRecordItem[] = [];
  @State private popularArtists: ApiArtistItem[] = [];
  @State private isLoadingRecords: boolean = true;
  @State private isLoadingArtists: boolean = true;
  @State private recordsError: string = '';
  @State private artistsError: string = '';
  @State private failedImages: Set<string> = new Set(); // è¨˜éŒ„åŠ è¼‰å¤±æ•—çš„åœ–ç‰‡URL

  // é¢œè‰²ä¸»é¢˜
  private primaryColor: string = '#FFFFFF';
  private secondaryColor: string = '#3d3d6b';
  private bgColor: string = '#12121e';
  private textPrimary: string = '#ffffff';
  private textSecondary: string = '#a0a0d0';
  private accentColor: string = '#4ECDC4';

  private musicApiService: MusicApiService = new MusicApiService();

  async aboutToAppear(): Promise<void> {
    await this.loadTrendingRecords();
    await this.loadPopularArtists();
  }

  private async loadTrendingRecords(): Promise<void> {
    try {
      this.isLoadingRecords = true;
      this.recordsError = '';
      const response = await this.musicApiService.getTrendingRecords();
      if (response?.success && response.data) {
        this.trendingRecords = response.data;
      } else {
        this.recordsError = response?.error || 'åŠ è½½å¤±è´¥';
      }
    } catch (error) {
      console.error('åŠ è½½çƒ­é—¨å”±ç‰‡å¤±è´¥:', error);
      this.recordsError = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    } finally {
      this.isLoadingRecords = false;
    }
  }

  private async loadPopularArtists(): Promise<void> {
    try {
      this.isLoadingArtists = true;
      this.artistsError = '';
      const response = await this.musicApiService.getPopularArtists();
      if (response?.success && response.data) {
        this.popularArtists = response.data;
      } else {
        this.artistsError = response?.error || 'åŠ è½½å¤±è´¥';
      }
    } catch (error) {
      console.error('åŠ è½½çƒ­é—¨è‰ºæœ¯å®¶å¤±è´¥:', error);
      this.artistsError = 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
    } finally {
      this.isLoadingArtists = false;
    }
  }

  // è™•ç†å”±ç‰‡é»æ“Šäº‹ä»¶
  private onRecordClick(record: ApiRecordItem): void {
    console.log('ç‚¹å‡»å”±ç‰‡:', record);
    try {
      router.pushUrl({
        url: 'pages/RecordDetail',
        params: {
          recordId: record.id, // ç›´æ¥ä¼ é€’stringç±»å‹çš„recordId
          recordTitle: record.title,
          recordArtist: record.artist,
          recordImage: record.image
        }
      });
    } catch (error) {
      console.error('è·³è½¬åˆ°å”±ç‰‡è¯¦æƒ…é¡µé¢å¤±è´¥:', error);
    }
  }

  private onArtistClick(artist: ApiArtistItem): void {
    router.pushUrl({
      url: 'pages/ArtistDetail',
      params: {
        artistId: artist.id,
        artistName: artist.name,
        imageUrl: artist.image
      }
    }).catch((error: Error) => {
      console.error('å¯¼èˆªåˆ°è‰ºæœ¯å®¶è¯¦æƒ…é¡µå¤±è´¥:', error);
    });
  }

  // ç”Ÿæˆæ¸å˜è‰²å ä½ç¬¦çš„æ–¹æ³•
  private getGradientColors(index: number): string[] {
    const gradients = [
      ['#FF6B6B', '#4ECDC4'], // çº¢åˆ°é’
      ['#A8E6CF', '#FFD93D'], // ç»¿åˆ°é»„
      ['#FF8A80', '#FF80AB'], // ç²‰çº¢æ¸å˜
      ['#81C784', '#4FC3F7'], // ç»¿åˆ°è“
      ['#FFB74D', '#F06292'], // æ©™åˆ°ç²‰
      ['#9575CD', '#64B5F6'], // ç´«åˆ°è“
      ['#FF7043', '#42A5F5'], // æ©™åˆ°è“
      ['#AB47BC', '#26C6DA'], // ç´«åˆ°é’
      ['#66BB6A', '#FFA726'], // ç»¿åˆ°æ©™
      ['#EF5350', '#7E57C2'], // çº¢åˆ°ç´«
    ];
    return gradients[index % gradients.length];
  }

  // å‰µå»ºå”±ç‰‡å°é¢å ä½ç¬¦çµ„ä»¶
  @Builder
  private RecordPlaceholder(record: ApiRecordItem, index: number, width: number = 144, height: number = 144) {
    Stack() {
      // æ¼¸è®ŠèƒŒæ™¯
      Row() {}
        .width(width)
        .height(height)
        .borderRadius(8)
        .linearGradient({
          angle: 45,
          colors: [
            [this.getGradientColors(index)[0], 0.0],
            [this.getGradientColors(index)[1], 1.0]
          ]
        })
      
      // å”±ç‰‡åç¨±æ–‡å­—
      Column({ space: 4 }) {
        Text(record.title || 'æœªçŸ¥å°ˆè¼¯')
          .fontSize(width > 120 ? 14 : 12)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .textAlign(TextAlign.Center)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .textShadow({ radius: 2, color: Color.Black, offsetX: 1, offsetY: 1 })
        
        Text(record.artist || 'æœªçŸ¥è—è¡“å®¶')
          .fontSize(width > 120 ? 12 : 10)
          .fontColor('#E0E0E0')
          .textAlign(TextAlign.Center)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
          .textShadow({ radius: 1, color: Color.Black, offsetX: 1, offsetY: 1 })
      }
      .padding(8)
      .width(width - 16)
      .justifyContent(FlexAlign.Center)
    }
    .width(width)
    .height(height)
  }

  // æœç´¢å”±ç‰‡çš„æ–¹æ³•
  private searchRecords() {
    if (this.searchText.trim()) {
      router.pushUrl({
        url: 'pages/SearchResults',
        params: {
          query: this.searchText
        }
      });
    }
  }

  // æ£€æŸ¥å›¾ç‰‡URLæ˜¯å¦æœ‰æ•ˆçš„æ–¹æ³•
  private isValidImageUrl(url: string): boolean {
    return !!(url && url.trim() !== '' && (url.startsWith('http') || url.startsWith('https')));
  }


  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('äº«èƒ¶')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.textPrimary)
      }
      .width('100%')
      .height(60)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.bgColor)

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 32 }) {
          // æœç´¢æ¡†
          Row() {
            Image($r('app.media.search'))
              .width(20)
              .height(20)
              .fillColor(this.textSecondary)
              .margin({ left: 12 })

            TextInput({ placeholder: 'æœç´¢å”±ç‰‡ã€CDåç§°å’Œè‰ºæœ¯å®¶', text: this.searchText })
              .placeholderColor(this.textSecondary)
              .fontColor(this.textPrimary)
              .backgroundColor(Color.Transparent)
              .border({ width: 0 })
              .layoutWeight(1)
              .onChange((value: string) => {
                this.searchText = value;
              })
              .onSubmit(() => {
                if (this.searchText.trim().length > 0) {
                  this.searchRecords();
                }
              })

            if (this.searchText.length > 0) {
              Image($r('app.media.close'))
                .width(20)
                .height(20)
                .fillColor(this.textSecondary)
                .margin({ right: 12 })
                .onClick(() => {
                  this.searchText = '';
                })
            }
          }
          .width('100%')
          .height(48)
          .backgroundColor(this.secondaryColor + '80')
          .borderRadius(8)
          .alignItems(VerticalAlign.Center)

          // çƒ­é—¨å”±ç‰‡åŒºåŸŸ
          Column({ space: 16 }) {
            Row() {
              Text('æ½®æµè¶‹åŠ¿')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.textPrimary)
              
              Blank()
              
              Text('...')
                .fontSize(14)
                .fontColor(this.textSecondary)
                .onClick(() => {
                  // å¯ä»¥æ·»åŠ æŸ¥çœ‹å…¨éƒ¨çš„é€»è¾‘
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            
            if (this.isLoadingRecords) {
              // åŠ è½½çŠ¶æ€
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color(this.textSecondary)
                
                Text('æ­£åœ¨åŠ è½½çƒ­é—¨å”±ç‰‡...')
                  .fontSize(14)
                  .fontColor(this.textSecondary)
                  .margin({ left: 8 })
              }
              .justifyContent(FlexAlign.Center)
              .width('100%')
              .height(120)
            } else if (this.recordsError) {
              // é”™è¯¯çŠ¶æ€
              Column({ space: 8 }) {
                Text('ğŸ˜”')
                  .fontSize(24)
                
                Text(this.recordsError)
                  .fontSize(14)
                  .fontColor(this.textSecondary)
                  .textAlign(TextAlign.Center)
                
                Button('é‡è¯•')
                  .fontSize(12)
                  .backgroundColor(this.secondaryColor)
                  .borderRadius(16)
                  .padding({ left: 16, right: 16, top: 6, bottom: 6 })
                  .onClick(() => {
                    this.loadTrendingRecords();
                  })
              }
              .justifyContent(FlexAlign.Center)
              .width('100%')
              .height(120)
            } else {
              // æ•°æ®å±•ç¤º
              Scroll() {
                Row({ space: 16 }) {
                  ForEach(this.trendingRecords, (record: ApiRecordItem, index: number) => {
                    Column({ space: 8 }) {
                      // å›¾ç‰‡æˆ–å ä½ç¬¦ - å¢å¼ºé”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
                      if (this.isValidImageUrl(record.image) && !this.failedImages.has(record.image)) {
                        Image(record.image)
                          .width(144)
                          .height(144)
                          .borderRadius(8)
                          .objectFit(ImageFit.Cover)
                          .alt(`${record.title} by ${record.artist}`)
                          .onError(() => {
                            // åœ–ç‰‡åŠ è¼‰å¤±æ•—æ™‚ï¼Œè¨˜éŒ„å¤±æ•—çš„URLä¸¦è§¸ç™¼é‡æ–°æ¸²æŸ“
                            console.error(`Failed to load image: ${record.image} for ${record.title}`);
                            this.failedImages.add(record.image);
                            // å¼ºåˆ¶è§¦å‘çŠ¶æ€æ›´æ–°ä»¥é‡æ–°æ¸²æŸ“
                            this.trendingRecords = [...this.trendingRecords];
                          })
                          .onComplete(() => {
                            console.log(`Successfully loaded image for: ${record.title}`);
                          })
                      } else {
                        // ä½¿ç”¨æ–°çš„å ä½ç¬¦çµ„ä»¶
                        this.RecordPlaceholder(record, index, 144, 144)
                      }

                      Column({ space: 4 }) {
                        Text(record.title || 'æœªçŸ¥ä¸“è¾‘')
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor(this.textPrimary)
                          .maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })

                        Text(record.artist)
                          .fontSize(12)
                          .fontColor(this.textSecondary)
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }
                      .width(144)
                      .alignItems(HorizontalAlign.Start)
                    }
                    .onClick(() => {
                      this.onRecordClick(record);
                    })
                  })
                }
                .padding({ left: 16, right: 16 })
              }
              .scrollable(ScrollDirection.Horizontal)
              .scrollBar(BarState.Off)
              .margin({ left: -16, right: -16 })
            }
          }

          // æµè¡Œè‰ºæœ¯å®¶åŒºåŸŸ
          this.PopularArtistsSection()
        }
        .padding({ left: 16, right: 16, top: 16, bottom: 80 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¯¼èˆªæ 
      this.BottomNavigation()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.bgColor)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
  }

  @Builder
  private PopularArtistsSection() {
    Column({ space: 16 }) {
      Row() {
        Text('çƒ­é—¨è‰ºæœ¯å®¶')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.textPrimary)
        
        Blank()
        
        Text('...')
          .fontSize(14)
          .fontColor(this.textSecondary)
          .onClick(() => {
            // å¯ä»¥æ·»åŠ æŸ¥çœ‹å…¨éƒ¨çš„é€»è¾‘
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
      
      if (this.isLoadingArtists) {
        // åŠ è½½çŠ¶æ€
        Row() {
          LoadingProgress()
            .width(24)
            .height(24)
            .color(this.accentColor)
          
          Text('æ­£åœ¨åŠ è½½çƒ­é—¨è‰ºæœ¯å®¶...')
            .fontSize(14)
            .fontColor(this.textSecondary)
            .margin({ left: 8 })
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .height(120)
      } else if (this.artistsError) {
        // é”™è¯¯çŠ¶æ€
        Column({ space: 8 }) {
          Text('ğŸ˜”')
            .fontSize(24)
          
          Text(this.artistsError)
            .fontSize(14)
            .fontColor(this.textSecondary)
            .textAlign(TextAlign.Center)
          
          Button('é‡è¯•')
            .fontSize(12)
            .backgroundColor(this.accentColor)
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .onClick(() => {
              this.loadPopularArtists();
            })
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .height(120)
      } else {
        // æ•°æ®å±•ç¤º
        Column({ space: 16 }) {
          ForEach(this.popularArtists, (artist: ApiArtistItem, index: number) => {
            this.ArtistCard(artist, index)
          })
        }
        .padding({ left: 20, right: 20 })
      }
    }
  }

  @Builder
  private RecordCard(record: ApiRecordItem, index: number) {
    Column({ space: 8 }) {
      // å›¾ç‰‡æˆ–å ä½ç¬¦
      if (this.isValidImageUrl(record.image) && !this.failedImages.has(record.image)) {
        Image(record.image)
          .width(144)
          .height(144)
          .borderRadius(8)
          .objectFit(ImageFit.Cover)
          .onError(() => {
            // åœ–ç‰‡åŠ è¼‰å¤±æ•—æ™‚ï¼Œè¨˜éŒ„å¤±æ•—çš„URLä¸¦è§¸ç™¼é‡æ–°æ¸²æŸ“
            console.error(`Failed to load image: ${record.image}`);
            this.failedImages.add(record.image);
          })
      } else {
        // ä½¿ç”¨æ–°çš„å ä½ç¬¦çµ„ä»¶
        this.RecordPlaceholder(record, index, 144, 144)
      }

      Column({ space: 4 }) {
        Text(record.title || 'æœªçŸ¥ä¸“è¾‘')
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.textPrimary)
          .maxLines(2)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(record.artist || 'æœªçŸ¥è‰ºæœ¯å®¶')
          .fontSize(12)
          .fontColor(this.textSecondary)
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .width(144)
      .alignItems(HorizontalAlign.Start)
    }
    .onClick(() => {
      this.onRecordClick(record);
    })
  }

  @Builder
  private ArtistCard(artist: ApiArtistItem, index: number) {
    Row({ space: 16 }) {
      // è‰ºæœ¯å®¶å¤´åƒæˆ–æ¸å˜è‰²å ä½ç¬¦
      if (this.isValidImageUrl(artist.image)) {
        Image(artist.image)
          .width(64)
          .height(64)
          .borderRadius(32)
          .objectFit(ImageFit.Cover)
      } else {
        // åœ†å½¢æ¸å˜è‰²å ä½ç¬¦
        Row() {}
          .width(64)
          .height(64)
          .borderRadius(32)
          .linearGradient({
            angle: 135,
            colors: [
              [this.getGradientColors(index + 3)[0], 0.0],
              [this.getGradientColors(index + 3)[1], 1.0]
            ]
          })
      }

      Column({ space: 4 }) {
        Text(artist.name || 'æœªçŸ¥è‰ºæœ¯å®¶')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.textPrimary)

        Text('Artist')
          .fontSize(14)
          .fontColor(this.textSecondary)
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      Image($r('app.media.arrow_right'))
        .width(24)
        .height(24)
        .fillColor(this.textSecondary)
    }
    .width('100%')
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      this.onArtistClick(artist);
    })
  }

  @Builder
  private BottomNavigation() {
    Row() {
      Column({ space: 4 }) {
        Image($r('app.media.search'))
          .width(24)
          .height(24)
          .fillColor(this.currentTab === 0 ? this.primaryColor : this.textSecondary)

        Text('æœå”±ç‰‡')
          .fontSize(10)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 0 ? this.primaryColor : this.textSecondary)
      }
      .layoutWeight(1)
      .onClick(() => {
        this.currentTab = 0;
        // å½“å‰å·²åœ¨é¦–é¡µï¼Œæ— éœ€è·³è½¬
      })

      Column({ space: 4 }) {
        Image($r('app.media.grid'))
          .width(24)
          .height(24)
          .fillColor(this.currentTab === 1 ? this.primaryColor : this.textSecondary)

        Text('å”±ç‰‡å¢™')
          .fontSize(10)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 1 ? this.primaryColor : this.textSecondary)
      }
      .layoutWeight(1)
      .onClick(() => {
        this.currentTab = 1;
        // å¯¼èˆªåˆ°å”±ç‰‡å¢™é¡µé¢
        router.pushUrl({ url: 'pages/RecordWall' });
      })

      Column({ space: 4 }) {
        Image($r('app.media.history'))
          .width(24)
          .height(24)
          .fillColor(this.currentTab === 2 ? this.primaryColor : this.textSecondary)

        Text('æ—¶å…‰æœº')
          .fontSize(10)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 2 ? this.primaryColor : this.textSecondary)
      }
      .layoutWeight(1)
      .onClick(() => {
        this.currentTab = 2;
        // å¯¼èˆªåˆ°æ—¶å…‰æœºé¡µé¢
        router.pushUrl({ url: 'pages/TimeMachine' });
      })

      Column({ space: 4 }) {
        Image($r('app.media.person'))
          .width(24)
          .height(24)
          .fillColor(this.currentTab === 3 ? this.primaryColor : this.textSecondary)

        Text('æˆ‘')
          .fontSize(10)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.currentTab === 3 ? this.primaryColor : this.textSecondary)
      }
      .layoutWeight(1)
      .onClick(() => {
        this.currentTab = 3;
        // å¯¼èˆªåˆ°Profileé¡µé¢
        router.pushUrl({ url: 'pages/Profile' });
      })
    }
    .width('100%')
    .height(80)
    .padding({ top: 8, bottom: 8 })
    .backgroundColor('#000000CC')
    .border({ width: { top: 1 }, color: this.secondaryColor + '80' })
  }
}