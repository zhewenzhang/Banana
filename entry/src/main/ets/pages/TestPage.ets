import { MusicApiService, ApiRecordItem, ApiArtistItem } from '../services/MusicApiService';

@Entry
@Component
struct TestPage {
  @State private testResults: string[] = [];
  @State private isLoading: boolean = false;
  
  private musicApiService: MusicApiService = new MusicApiService();
  
  // é¢œè‰²ä¸»é¢˜
  private bgColor: string = '#12121e';
  private textPrimary: string = '#ffffff';
  private textSecondary: string = '#a0a0d0';
  private accentColor: string = '#4ECDC4';

  private async testApiService(): Promise<void> {
    this.isLoading = true;
    this.testResults = [];
    
    try {
      // æµ‹è¯•èŽ·å–çƒ­é—¨å”±ç‰‡
      this.testResults.push('æ­£åœ¨æµ‹è¯•èŽ·å–çƒ­é—¨å”±ç‰‡...');
      const records = await this.musicApiService.getTrendingRecords();
      this.testResults.push(`âœ… èŽ·å–åˆ° ${records.length} å¼ çƒ­é—¨å”±ç‰‡`);
      
      if (records.length > 0) {
        const firstRecord = records[0];
        this.testResults.push(`ç¬¬ä¸€å¼ å”±ç‰‡: ${firstRecord?.name || 'æœªçŸ¥'} - ${firstRecord?.artist || 'æœªçŸ¥è‰ºæœ¯å®¶'}`);
      }
      
      // æµ‹è¯•èŽ·å–çƒ­é—¨è‰ºæœ¯å®¶
      this.testResults.push('æ­£åœ¨æµ‹è¯•èŽ·å–çƒ­é—¨è‰ºæœ¯å®¶...');
      const artists = await this.musicApiService.getPopularArtists();
      this.testResults.push(`âœ… èŽ·å–åˆ° ${artists.length} ä½çƒ­é—¨è‰ºæœ¯å®¶`);
      
      if (artists.length > 0) {
        const firstArtist = artists[0];
        this.testResults.push(`ç¬¬ä¸€ä½è‰ºæœ¯å®¶: ${firstArtist?.name || 'æœªçŸ¥è‰ºæœ¯å®¶'}`);
      }
      
      this.testResults.push('ðŸŽ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼');
      
    } catch (error) {
      this.testResults.push(`âŒ æµ‹è¯•å¤±è´¥: ${error}`);
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column({ space: 20 }) {
      // æ ‡é¢˜
      Text('API æœåŠ¡æµ‹è¯•')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.textPrimary)
        .margin({ top: 40 })

      // æµ‹è¯•æŒ‰é’®
      Button('å¼€å§‹æµ‹è¯• API æœåŠ¡')
        .fontSize(16)
        .backgroundColor(this.accentColor)
        .borderRadius(8)
        .padding({ horizontal: 20, vertical: 12 })
        .onClick(() => {
          this.testApiService();
        })
        .enabled(!this.isLoading)

      // åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isLoading) {
        Row({ space: 8 }) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(this.accentColor)
          
          Text('æµ‹è¯•ä¸­...')
            .fontSize(14)
            .fontColor(this.textSecondary)
        }
      }

      // æµ‹è¯•ç»“æžœ
      if (this.testResults.length > 0) {
        Column({ space: 8 }) {
          Text('æµ‹è¯•ç»“æžœ:')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.textPrimary)
            .alignSelf(ItemAlign.Start)

          ForEach(this.testResults, (result: string, index: number) => {
            Text(result)
              .fontSize(14)
              .fontColor(this.textSecondary)
              .padding({ horizontal: 16, vertical: 4 })
              .backgroundColor('#1a1a2e')
              .borderRadius(4)
              .width('100%')
              .textAlign(TextAlign.Start)
          })
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }

      Blank()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.bgColor)
    .padding(20)
  }
}