import router from '@ohos.router';
import { LoginModal } from '../components/LoginModal';
import { UserData, UserStats } from '../common/UserTypes';
import { AuthService } from '../services/AuthService';
import { StorageManager } from '../common/StorageManager';

// ç”¨æˆ·è®¾ç½®é¡¹æ¥å£
interface SettingItem {
  icon: string;
  title: string;
  hasToggle?: boolean;
  isToggled?: boolean;
}

@Entry
@Component
struct Profile {
  @State currentTab: number = 3; // Profileé¡µé¢å¯¹åº”tab 3
  @State isLoggedIn: boolean = false; // ç™»éŒ„ç‹€æ…‹
  @State showLoginModal: boolean = false; // ç™»éŒ„å½ˆçª—é¡¯ç¤ºç‹€æ…‹
  @State loginModalMode: boolean = true; // ç™»éŒ„å½ˆçª—æ¨¡å¼ï¼štrue=ç™»éŒ„ï¼Œfalse=è¨»å†Š

  // é¢œè‰²ä¸»é¢˜
  private primaryColor: string = '#FFFFFF';
  private secondaryColor: string = '#3d3d6b';
  private bgColor: string = '#12121e';
  private cardBgColor: string = '#1a1a32';
  private textPrimary: string = '#ffffff';
  private textSecondary: string = '#9393c8';
  private customBorderColor: string = '#2a2a4a';

  // ç”¨æˆ·æ•°æ® - é»˜èªç‚ºç©ºï¼Œç™»éŒ„å¾Œå¡«å……
  @State userData: UserData = {
    id: '', // æ·»åŠ å¿…éœ€çš„idå­—æ®µ
    name: '',
    username: '',
    joinDate: '',
    bio: '',
    avatar: '',
    stats: {
      records: 0,
      followers: 0,
      following: 0
    }
  };

  // è®¾ç½®é€‰é¡¹
  private settingItems: SettingItem[] = [
    { icon: 'ic_favorite', title: 'æˆ‘çš„æ”¶è—' },
    { icon: 'help', title: 'å¸®åŠ©å’Œæ”¯æŒ' },
    { icon: 'info', title: 'å…³äºæˆ‘ä»¬' }
  ];

  // ç»„ä»¶å³å°†å‡ºç°æ—¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
  async aboutToAppear() {
    console.log('Profileé¡µé¢å³å°†å‡ºç°');
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ¢å¤ç”¨æˆ·æ•°æ®
    await this.checkLoginStatus();
  }

  // ç”Ÿæˆæ¸å˜è‰²å ä½ç¬¦çš„æ–¹æ³•
  private getGradientColors(index: number): string[] {
    const gradients = [
      ['#FF6B6B', '#4ECDC4'],
      ['#A8E6CF', '#FFD93D'],
      ['#FF8A80', '#FF80AB'],
      ['#81C784', '#4FC3F7'],
      ['#FFB74D', '#F06292'],
      ['#9575CD', '#64B5F6'],
    ];
    return gradients[index % gradients.length];
  }

  // æ£€æŸ¥å›¾ç‰‡URLæ˜¯å¦æœ‰æ•ˆçš„æ–¹æ³•
  private isValidImageUrl(url: string): boolean {
    return !!(url && url.trim() !== '' && (url.startsWith('http') || url.startsWith('https')));
  }

  // è™•ç†ç™»éŒ„æˆåŠŸ
  private handleLoginSuccess = (userData: UserData) => {
    console.log('=== Profile handleLoginSuccess å¼€å§‹ ===');
    console.log('æ¥æ”¶åˆ°çš„ç”¨æˆ·æ•°æ®:', userData);
    
    this.isLoggedIn = true;
    this.userData = userData;
    this.showLoginModal = false;
    
    console.log('Profileç»„ä»¶çŠ¶æ€æ›´æ–°å:');
    console.log('isLoggedIn:', this.isLoggedIn);
    console.log('userData:', this.userData);
    console.log('=== Profile handleLoginSuccess ç»“æŸ ===');
  }

  // è™•ç†ç™»å‡º
  private handleLogout = async () => {
    console.log('=== Profile handleLogout å¼€å§‹ ===');
    
    try {
      // è°ƒç”¨AuthServiceçš„logoutæ–¹æ³•æ¸…é™¤æœ¬åœ°å­˜å‚¨
      const authService = AuthService.getInstance();
      const logoutResult = await authService.logout();
      
      if (logoutResult) {
        console.log('AuthService logout æˆåŠŸ');
      } else {
        console.error('AuthService logout å¤±è´¥');
      }
    } catch (error) {
      console.error('logout è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    }
    
    // é‡ç½®ç»„ä»¶çŠ¶æ€
    this.isLoggedIn = false;
    this.userData = {
      id: '', // æ·»åŠ å¿…éœ€çš„idå­—æ®µ
      name: '',
      username: '',
      joinDate: '',
      bio: '',
      avatar: '',
      stats: {
        records: 0,
        followers: 0,
        following: 0
      }
    };
    
    console.log('Profileç»„ä»¶çŠ¶æ€å·²é‡ç½®');
    console.log('=== Profile handleLogout ç»“æŸ ===');
  }

  // é¡¯ç¤ºç™»éŒ„å½ˆçª—
  private showLogin = () => {
    this.showLoginModal = true;
  }

  // æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶æ¢å¤ç”¨æˆ·æ•°æ®
  private async checkLoginStatus() {
    console.log('=== Profile checkLoginStatus å¼€å§‹ ===');
    
    try {
      const authService = AuthService.getInstance();
      const isLoggedIn = await authService.isLoggedIn();
      
      console.log('ç™»å½•çŠ¶æ€æ£€æŸ¥ç»“æœ:', isLoggedIn);
      
      if (isLoggedIn) {
        const currentUser = await authService.getCurrentUser();
        console.log('è·å–åˆ°çš„å½“å‰ç”¨æˆ·æ•°æ®:', currentUser);
        
        if (currentUser?.id) {
          console.log('ç”¨æˆ·ID:', currentUser.id);
          console.log('ç”¨æˆ·IDç±»å‹:', typeof currentUser.id);
          
          this.isLoggedIn = true;
          this.userData = currentUser;
          
          console.log('Profileç»„ä»¶çŠ¶æ€å·²æ›´æ–°ä¸ºå·²ç™»å½•');
        } else {
          console.log('ç”¨æˆ·æ•°æ®æ— æ•ˆæˆ–ç¼ºå°‘IDå­—æ®µ');
          this.isLoggedIn = false;
        }
      } else {
        console.log('ç”¨æˆ·æœªç™»å½•');
        this.isLoggedIn = false;
      }
    } catch (error) {
      console.error('checkLoginStatus å¼‚å¸¸:', error);
      this.isLoggedIn = false;
    }
    
    console.log('=== Profile checkLoginStatus ç»“æŸ ===');
  }

  // æ§‹å»ºæœªç™»éŒ„ç‹€æ…‹çš„æç¤ºé é¢
  @Builder
  LoginPromptContent() {
    Stack() {
      // åŸæœ‰çš„ç™»å½•UIå†…å®¹ï¼ˆä¿æŒä¸å˜ï¼‰
      Column({ space: 32 }) {
        // æç¤ºæ–‡å­—
        Column({ space: 12 }) {
          Text('ä¸€èµ·äº«å—èƒ¶ç‰‡å§')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textPrimary)
            .textAlign(TextAlign.Center)

          Text('ç™»å½•åå¯ä»¥æ”¶è—å’Œäº¤æµå”±ç‰‡ä¿¡æ¯\nå°ä¼—çˆ±å¥½çš„å°å¤©åœ°')
            .fontSize(16)
            .fontColor(this.textSecondary)
            .textAlign(TextAlign.Center)
            .lineHeight(24)
        }

        // ç™»éŒ„å’Œè¨»å†ŠæŒ‰éˆ•
        Column({ space: 16 }) {
          Button('ç™»å½•')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(Color.White)
            .backgroundColor(this.secondaryColor)
            .borderRadius(8)
            .onClick(() => {
              this.loginModalMode = true; // è®¾ç½®ä¸ºç™»å½•æ¨¡å¼
              this.showLoginModal = true;
            })

          Button('æ³¨å†Œ')
            .width('100%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.primaryColor)
            .backgroundColor('transparent')
            .border({ width: 1, color: this.primaryColor })
            .borderRadius(8)
            .onClick(() => {
              this.loginModalMode = false; // è®¾ç½®ä¸ºæ³¨å†Œæ¨¡å¼
              this.showLoginModal = true;
            })
        }
        .width('100%')
        .padding({ left: 32, right: 32 })
      }
      .width('100%')
      .padding({ top: 60 })
      .justifyContent(FlexAlign.Center)

      // å¼€å‘ä¸­é®è”½å±‚
      Column({ space: 24 }) {
        // å¼€å‘ä¸­å›¾æ ‡
        Column({ space: 16 }) {
          // ä½¿ç”¨ç®€å•çš„å‡ ä½•å›¾å½¢ä½œä¸ºå¼€å‘å›¾æ ‡
          Row() {
            Column()
              .width(8)
              .height(8)
              .backgroundColor('#FFD93D')
              .borderRadius(4)
              .margin({ right: 4 })
            
            Column()
              .width(8)
              .height(8)
              .backgroundColor('#4ECDC4')
              .borderRadius(4)
              .margin({ right: 4 })
            
            Column()
              .width(8)
              .height(8)
              .backgroundColor('#FF6B6B')
              .borderRadius(4)
          }
          .justifyContent(FlexAlign.Center)
          .animation({
            duration: 1500,
            curve: Curve.EaseInOut,
            iterations: -1,
            playMode: PlayMode.Alternate
          })
          .scale({ x: 1.2, y: 1.2 })

          Text('ğŸš§')
            .fontSize(48)
            .fontColor('#FFD93D')
        }
        .alignItems(HorizontalAlign.Center)

        // å¼€å‘ä¸­æ–‡å­—
        Column({ space: 8 }) {
          Text('åŠŸèƒ½å¼€å‘ä¸­')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textPrimary)
            .textAlign(TextAlign.Center)

          Text('ç™»å½•æ³¨å†ŒåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­\næ•¬è¯·æœŸå¾…')
            .fontSize(16)
            .fontColor(this.textSecondary)
            .textAlign(TextAlign.Center)
            .lineHeight(24)
        }

        // å¼€å‘è¿›åº¦æŒ‡ç¤º
        Column({ space: 12 }) {
          Text('å¼€å‘è¿›åº¦')
            .fontSize(14)
            .fontColor(this.textSecondary)
            .textAlign(TextAlign.Center)

          // è¿›åº¦æ¡
          Row() {
            Column()
              .width('60%')
              .height(4)
              .backgroundColor('#4ECDC4')
              .borderRadius(2)
            
            Column()
              .width('40%')
              .height(4)
              .backgroundColor(this.customBorderColor)
              .borderRadius(2)
          }
          .width('80%')
          .backgroundColor(this.customBorderColor)
          .borderRadius(2)

          Text('60% å®Œæˆ')
            .fontSize(12)
            .fontColor(this.textSecondary + '80')
            .textAlign(TextAlign.Center)
        }
        .alignItems(HorizontalAlign.Center)

        // é¢„è®¡å®Œæˆæ—¶é—´
        Column({ space: 4 }) {
          Text('é¢„è®¡å®Œæˆæ—¶é—´')
            .fontSize(12)
            .fontColor(this.textSecondary + '60')
            .textAlign(TextAlign.Center)

          Text('å³å°†ä¸Šçº¿')
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .fontColor('#4ECDC4')
            .textAlign(TextAlign.Center)
        }
      }
      .width('100%')
      .height('100%')
      .padding({ left: 32, right: 32, top: 60 })
      .backgroundColor(this.bgColor + 'F0') // åŠé€æ˜èƒŒæ™¯
      .backdropBlur(10) // èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
  }

  // æ§‹å»ºå·²ç™»éŒ„ç‹€æ…‹çš„ç”¨æˆ¶è³‡æ–™é é¢
  @Builder
  UserProfileContent() {
    Column({ space: 24 }) {
      // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
      Column({ space: 16 }) {
        // ç”¨æˆ·ä¿¡æ¯
        Column({ space: 4 }) {
          Text(this.userData?.name || '')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textPrimary)

          Text(this.userData?.username || '')
            .fontSize(16)
            .fontColor(this.textSecondary)

          Text(this.userData?.bio || '')
            .fontSize(14)
            .fontColor(this.textSecondary + '80')
            .textAlign(TextAlign.Center)
            .maxLines(2)
            .textOverflow({ overflow: TextOverflow.Ellipsis })

          Text(this.userData?.joinDate || '')
            .fontSize(12)
            .fontColor(this.textSecondary + '60')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Center)

        // ç¼–è¾‘èµ„æ–™æŒ‰é’®
        Button('ç¼–è¾‘èµ„æ–™')
          .width(120)
          .height(36)
          .fontSize(14)
          .fontColor(this.primaryColor)
          .backgroundColor('transparent')
          .border({ width: 1, color: this.primaryColor })
          .borderRadius(18)
          .onClick(() => {
            console.log('Edit Profile clicked');
          })
      }
      .alignItems(HorizontalAlign.Center)

      // ç»Ÿè®¡æ•°æ®
      Row({ space: 12 }) {
        // Records
        Column({ space: 4 }) {
          Text((this.userData?.stats?.records || 0).toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textPrimary)

          Text('è®°å½•')
            .fontSize(14)
            .fontColor(this.textSecondary)
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor((this.cardBgColor || '#FFFFFF') + '80')
        .borderRadius(8)
        .border({ width: 1, color: this.customBorderColor || '#E0E0E0' })
        .alignItems(HorizontalAlign.Center)

        // Followers
        Column({ space: 4 }) {
          Text((this.userData?.stats?.followers || 0).toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textPrimary)

          Text('å…³æ³¨è€…')
            .fontSize(14)
            .fontColor(this.textSecondary)
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor((this.cardBgColor || '#FFFFFF') + '80')
        .borderRadius(8)
        .border({ width: 1, color: this.customBorderColor || '#E0E0E0' })
        .alignItems(HorizontalAlign.Center)

        // Following
        Column({ space: 4 }) {
          Text((this.userData?.stats?.following || 0).toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.textPrimary)

          Text('æ­£åœ¨å…³æ³¨')
            .fontSize(14)
            .fontColor(this.textSecondary)
        }
        .layoutWeight(1)
        .padding(12)
        .backgroundColor((this.cardBgColor || '#FFFFFF') + '80')
        .borderRadius(8)
        .border({ width: 1, color: this.customBorderColor || '#E0E0E0' })
        .alignItems(HorizontalAlign.Center)
      }

      // è®¾ç½®åŒºåŸŸ
      Column({ space: 0 }) {
        Text('è®¾å®š')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.textPrimary)
          .width('100%')
          .margin({ bottom: 12 })

        Column() {
          ForEach(this.settingItems, (item: SettingItem, index: number) => {
            Column() {
              Row({ space: 16 }) {
                // å›¾æ ‡
                Row() {
                  Image($r(`app.media.${item?.icon || 'ic_default'}`))
                    .width(20)
                    .height(20)
                    .fillColor(this.textPrimary || '#000000')
                }
                .width(40)
                .height(40)
                .backgroundColor(this.customBorderColor || '#E0E0E0')
                .borderRadius(8)
                .justifyContent(FlexAlign.Center)

                // æ ‡é¢˜
                Text(item?.title || '')
                  .fontSize(16)
                  .fontColor(this.textPrimary || '#000000')
                  .layoutWeight(1)

                // åˆ‡æ¢å¼€å…³æˆ–ç®­å¤´
                if (item?.hasToggle) {
                  Toggle({ type: ToggleType.Switch, isOn: item?.isToggled || false })
                    .selectedColor(this.primaryColor || '#007AFF')
                    .switchPointColor(Color.White)
                    .onChange((isOn: boolean) => {
                      console.log(`${item?.title || ''} toggled: ${isOn}`);
                    })
                } else {
                  Image($r('app.media.chevron_right'))
                    .width(20)
                    .height(20)
                    .fillColor(this.textSecondary || '#666666')
                }
              }
              .width('100%')
              .height(56)
              .padding({ left: 16, right: 16 })
              .onClick(() => {
                console.log(`Clicked: ${item?.title || ''}`);
                // å¤„ç†ä¸åŒè®¾ç½®é¡¹çš„ç‚¹å‡»äº‹ä»¶
                if (item?.title === 'æˆ‘çš„æ”¶è—') {
                  router.pushUrl({ url: 'pages/FavoritesPage' });
                }
              })

              // åˆ†å‰²çº¿ï¼ˆé™¤äº†æœ€åä¸€é¡¹ï¼‰
              if (index < (this.settingItems?.length || 0) - 1) {
                Divider()
                  .color(this.customBorderColor || '#E0E0E0')
                  .strokeWidth(1)
              }
            }
          })
        }
        .backgroundColor((this.cardBgColor || '#FFFFFF') + '80')
        .borderRadius(8)
        .border({ width: 1, color: this.customBorderColor || '#E0E0E0' })
      }

      // é€€å‡ºç™»å½•æŒ‰é’®
      Button('ç™»å‡º')
        .width('100%')
        .height(48)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#FF4444')
        .backgroundColor((this.cardBgColor || '#FFFFFF') + '80')
        .border({ width: 1, color: '#FF4444' + '40' })
        .borderRadius(8)
        .onClick(() => {
          this.handleLogout();
        })
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Image($r('app.media.arrow_back'))
          .width(24)
          .height(24)
          .fillColor(this.textPrimary)
          .onClick(() => {
            // è¿”å›ä¸Šä¸€é¡µé€»è¾‘
            router.back();
          })

        Text('æˆ‘')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.textPrimary)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ç¬¦ä¿æŒå¯¹ç§°
        Row() {}
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor(this.bgColor + 'CC')

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Scroll() {
        Column({ space: 24 }) {
          // æ ¹æ“šç™»éŒ„ç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹
          if (this.isLoggedIn) {
            // å·²ç™»éŒ„ - é¡¯ç¤ºç”¨æˆ¶ä¿¡æ¯
            this.UserProfileContent()
          } else {
            // æœªç™»éŒ„ - é¡¯ç¤ºç™»éŒ„æç¤º
            this.LoginPromptContent()
          }
        }
        .padding({ left: 16, right: 16, top: 16, bottom: 80 })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        Column({ space: 4 }) {
          Image($r('app.media.search'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 0 ? this.primaryColor : this.textSecondary)

          Text('æœå”±ç‰‡')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 0 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 0;
          // å¯¼èˆªåˆ°æœç´¢é¡µé¢
          router.pushUrl({ url: 'pages/Index' });
        })

        Column({ space: 4 }) {
          Image($r('app.media.grid'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 1 ? this.primaryColor : this.textSecondary)

          Text('å”±ç‰‡å¢™')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 1 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 1;
          // å¯¼èˆªåˆ°å”±ç‰‡å¢™é¡µé¢
          router.pushUrl({ url: 'pages/RecordWall' });
        })

        Column({ space: 4 }) {
          Image($r('app.media.history'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 2 ? this.primaryColor : this.textSecondary)

          Text('æ—¶å…‰æœº')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 2 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 2;
          // å¯¼èˆªåˆ°æ—¶å…‰æœºé¡µé¢
          router.pushUrl({ url: 'pages/TimeMachine' });
        })

        Column({ space: 4 }) {
          Image($r('app.media.person'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 3 ? this.primaryColor : this.textSecondary)

          Text('æˆ‘')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 3 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 3;
        })
      }
      .width('100%')
      .height(80)
      .padding({ top: 8, bottom: 8 })
      .backgroundColor('#000000CC')
      .border({ width: { top: 1 }, color: this.secondaryColor + '80' })

      // LoginModal å¼¹çª—
      if (this.showLoginModal) {
        LoginModal({
          isVisible: this.showLoginModal,
          initialMode: this.loginModalMode, // ä¼ å…¥åˆå§‹æ¨¡å¼
          onClose: () => {
            this.showLoginModal = false;
          },
          onLoginSuccess: (userData: UserData) => {
            this.handleLoginSuccess(userData);
          }
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.bgColor)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
  }
}