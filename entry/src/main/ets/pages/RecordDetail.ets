import router from '@ohos.router';
import http from '@ohos.net.http';
import { FavoriteService } from '../services/FavoriteService';
import { AuthService } from '../services/AuthService';
import { FavoriteRequest } from '../common/UserTypes';
import { FavoriteStorageManager } from '../services/FavoriteStorageManager';
import { ApiRecordItem, MusicApiService } from '../services/MusicApiService';
import { ApiConfig } from '../common/ApiConfig';

// å®šç¾©Discogs APIè¿”å›çš„è©³ç´°æ•¸æ“šæ¥å£
interface DiscogsArtist {
  name: string;
  role?: string;
}

interface DiscogsExtraArtist {
  name: string;
  role: string;
}

interface DiscogsTrack {
  position: string;
  title: string;
  duration?: string;
  artists?: DiscogsArtist[];
  extraartists?: DiscogsExtraArtist[];
}

interface DiscogsLabel {
  name: string;
  catno?: string;
}

interface DiscogsImage {
  type: string;
  uri: string;
  uri150?: string;
  width?: number;
  height?: number;
}

interface DiscogsReleaseArtist {
  name: string;
}

interface DiscogsFormat {
  name: string;
  qty?: string;
  descriptions?: string[];
}

interface DiscogsCompany {
  name: string;
  entity_type_name: string;
}

// æ¨¡æ“¬æ•¸æ“šçš„é¡å‹å®šç¾©
interface MockRecordData {
  title: string;
  artist: string;
  year: string;
  genres: string[];
  image: string;
}

interface DiscogsReleaseDetail {
  id: number;
  title: string;
  artists: DiscogsReleaseArtist[];
  images?: DiscogsImage[];
  labels?: DiscogsLabel[];
  formats?: DiscogsFormat[];
  country?: string;
  released?: string;
  year?: number; // ç™¼è¡Œå¹´ä»½
  genres?: string[];
  styles?: string[];
  tracklist?: DiscogsTrack[];
  extraartists?: DiscogsExtraArtist[];
  companies?: DiscogsCompany[];
  notes?: string;
}

@Entry
@Component
struct RecordDetail {
  @State recordId: string = '';
  @State recordDetail: DiscogsReleaseDetail | null = null;
  @State isLoading: boolean = false;
  @State currentTab: number = 0;
  @State selectedImageIndex: number = 0;
  @State isFavorite: boolean = false; // æ”¶è—çŠ¶æ€
  @State private isProcessingFavorite: boolean = false; // æ”¶è—æ“ä½œå¤„ç†çŠ¶æ€
  private favoriteService: FavoriteService = FavoriteService.getInstance();
  private authService: AuthService = AuthService.getInstance();
  private storageManager: FavoriteStorageManager = FavoriteStorageManager.getInstance();

  // é¡è‰²ä¸»é¡Œ
  private primaryColor: string = '#FFFFFF';
  private secondaryColor: string = '#3d3d6b';
  private bgColor: string = '#12121e';
  private textPrimary: string = '#ffffff';
  private textSecondary: string = '#a0a0d0';
  private cardBgColor: string = '#1e1e2e';

  // Discogs APIé…ç½®
  private readonly DISCOGS_API_URL = 'https://api.discogs.com';
  private readonly USER_AGENT = 'BananaRecordApp/1.0';

  aboutToAppear() {
    console.log('=== RecordDetail aboutToAppear å¼€å§‹ ===');
    
    // åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨
    this.storageManager.initStorage();
    
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, Object>;
    console.log('è·¯ç”±å‚æ•°:', params);
    
    // æå–recordId
    this.recordId = (params?.recordId as string) || '';
    console.log('æå–çš„recordId:', this.recordId, 'ç±»å‹:', typeof this.recordId);
    
    // æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–çš„å”±ç‰‡ä¿¡æ¯å‚æ•°
    const recordTitle = params?.recordTitle as string;
    const recordArtist = params?.recordArtist as string;
    const recordImage = params?.recordImage as string;
    
    if (recordTitle && recordArtist) {
      // å¦‚æœæœ‰é¢å¤–çš„å”±ç‰‡ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨è¿™äº›ä¿¡æ¯æ„å»ºè¯¦æƒ…
      console.log('ä½¿ç”¨ä¼ é€’çš„å”±ç‰‡ä¿¡æ¯:', { recordTitle, recordArtist, recordImage });
      this.buildRecordFromParams(recordTitle, recordArtist, recordImage);
      this.checkFavoriteStatus(); // æ£€æŸ¥æ”¶è—çŠ¶æ€
    } else {
      // å¦åˆ™æŒ‰åŸæœ‰é€»è¾‘åŠ è½½
      if (this.recordId) {
        this.loadRecordDetail();
        this.checkFavoriteStatus(); // æ£€æŸ¥æ”¶è—çŠ¶æ€
      } else {
        console.error('æœªæä¾›recordIdå‚æ•°');
      }
    }
  }

  // æ–°å¢æ–¹æ³•ï¼šæ ¹æ®ä¼ é€’çš„å‚æ•°æ„å»ºå”±ç‰‡è¯¦æƒ…
  private buildRecordFromParams(title: string, artist: string, image?: string): void {
    this.isLoading = false;
    this.recordDetail = {
      id: parseInt(this.recordId) || 0,
      title: title,
      artists: [{ name: artist }],
      year: 2023,
      genres: ['Pop'],
      images: image ? [{ type: 'primary', uri: image, uri150: image }] : [],
      labels: [{ name: 'æœªçŸ¥å‚ç‰Œ', catno: 'N/A' }],
      formats: [{ name: 'Digital', descriptions: ['Album'] }],
      tracklist: [],
      extraartists: [],
      notes: `è¿™æ˜¯æ¥è‡ªé¦–é¡µæ½®æµè¶‹åŠ¿çš„çƒ­é—¨ä¸“è¾‘ã€Š${title}ã€‹ï¼Œç”±${artist}æ¼”å‡ºã€‚`,
      released: '2023',
      country: 'Unknown'
    };
    console.log('æ„å»ºçš„recordDetail:', this.recordDetail);
  }

  // è¼‰å…¥å”±ç‰‡è©³æƒ…
  private async loadRecordDetail() {
    if (!this.recordId) return;

    this.isLoading = true;
    
    try {
      // æ£€æŸ¥æ˜¯å¦é…ç½®äº†API Token
      if (!ApiConfig.hasDiscogsToken()) {
        console.warn('Discogs API Tokenæœªé…ç½®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
        this.loadMockDetail();
        return;
      }

      const httpRequest = http.createHttp();
      const url = `${ApiConfig.DISCOGS_API_URL}/releases/${this.recordId}`;
      
      console.log(`æ­£åœ¨åŠ è½½å”±ç‰‡è¯¦æƒ…ï¼ŒID: ${this.recordId}, URL: ${url}`);
      console.log('ä½¿ç”¨API Token:', ApiConfig.hasDiscogsToken() ? 'å·²é…ç½®' : 'æœªé…ç½®');
      
      const response = await httpRequest.request(url, {
        method: http.RequestMethod.GET,
        header: ApiConfig.getDiscogsHeaders(),
        connectTimeout: 10000,
        readTimeout: 10000
      });

      if (response.responseCode === 200) {
        const data = JSON.parse(response.result as string) as DiscogsReleaseDetail;
        console.log('âœ… æˆåŠŸä»Discogs APIè·å–å”±ç‰‡è¯¦æƒ…:', data.title);
        console.log('APIè¿”å›çš„å®Œæ•´æ•°æ®:', JSON.stringify(data, null, 2));
        this.recordDetail = data;
      } else if (response.responseCode === 404) {
        console.warn(`å”±ç‰‡ID ${this.recordId} åœ¨Discogsæ•°æ®åº“ä¸­ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®`);
        this.loadMockDetail();
      } else {
        console.error('Discogs API error:', response.responseCode, response.result);
        console.log('APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
        this.loadMockDetail();
      }
    } catch (error) {
      console.error('Load detail error:', error);
      console.log('ç½‘ç»œè¯·æ±‚å¼‚å¸¸ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
      this.loadMockDetail();
    } finally {
      this.isLoading = false;
    }
  }

  // è¼‰å…¥æ¨¡æ“¬è©³æƒ…æ•¸æ“š
  private loadMockDetail() {
    console.log('=== loadMockDetail å¼€å§‹ ===');
    console.log('å½“å‰recordId:', this.recordId);
    console.log('recordIdç±»å‹:', typeof this.recordId);
    console.log('âš ï¸ æ³¨æ„ï¼šå½“å‰æ˜¾ç¤ºçš„æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸æ˜¯çœŸå®çš„Discogs APIæ•°æ®');
    
    // æ ¹æ“šrecordIdç”Ÿæˆå°æ‡‰çš„æ¨¡æ“¬æ•¸æ“š - ä½¿ç”¨çœŸå®Discogsé«˜ä»·å€¼å”±ç‰‡æ•°æ®
    const mockDataMap: Record<string, MockRecordData> = {
      '249504': {
        title: 'Please Please Me',
        artist: 'The Beatles',
        year: '1963',
        genres: ['Rock', 'Pop'],
        image: 'https://i.discogs.com/r300-/release/249504-The-Beatles-Please-Please-Me.jpg'
      },
      '9823525': {
        title: 'Wish You Were Here',
        artist: 'Pink Floyd',
        year: '1975',
        genres: ['Rock', 'Progressive Rock'],
        image: 'https://i.discogs.com/r300-/release/9823525-Pink-Floyd-Wish-You-Were-Here.jpg'
      },
      '4262072': {
        title: 'Xanadu',
        artist: 'Olivia Newton-John & Electric Light Orchestra',
        year: '1980',
        genres: ['Pop', 'Soundtrack'],
        image: 'https://i.discogs.com/r300-/release/4262072-Olivia-Newton-John-Electric-Light-Orchestra-Xanadu.jpg'
      },
      '1218307': {
        title: 'Overseas',
        artist: 'Tommy Flanagan Trio',
        year: '1958',
        genres: ['Jazz'],
        image: 'https://i.discogs.com/r300-/release/1218307-Tommy-Flanagan-Trio-Overseas.jpg'
      },
      '5678901': {
        title: 'Your Love Is What I Want',
        artist: 'The Ravins',
        year: '1969',
        genres: ['Soul', 'Northern Soul'],
        image: 'https://i.discogs.com/r300-/release/5678901-The-Ravins-Your-Love-Is-What-I-Want.jpg'
      }
    };

    // ä¸ºåŠ¨æ€ç”Ÿæˆçš„recordIdæ·»åŠ é€šç”¨çš„æ¨¡æ‹Ÿæ•°æ®
    let mockData: MockRecordData = mockDataMap[this.recordId];
    
    if (!mockData) {
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„mockDataï¼Œç”Ÿæˆé€šç”¨çš„æ¨¡æ‹Ÿæ•°æ®
      console.log('æœªæ‰¾åˆ°å¯¹åº”çš„mockDataï¼Œä½¿ç”¨é€šç”¨æ¨¡æ‹Ÿæ•°æ®');
      mockData = {
        title: 'çƒ­é—¨ä¸“è¾‘',
        artist: 'çŸ¥åè‰ºæœ¯å®¶',
        year: '2023',
        genres: ['Pop', 'Rock'],
        image: 'https://i.scdn.co/image/ab67616d0000b273ef6f049cce6fcc59a6e52233'
      };
    }
    
    console.log('é€‰æ‹©çš„mockData:', mockData);
    console.log('æ˜¯å¦ä½¿ç”¨é»˜è®¤æ•°æ®:', !mockDataMap[this.recordId]);
    console.log('ğŸ’¡ æç¤ºï¼šè¦è·å–çœŸå®çš„å”±ç‰‡è¯¦æƒ…ï¼Œè¯·é…ç½®Discogs API Token');
    
    const mockArtists: DiscogsReleaseArtist[] = [{ name: mockData.artist }];
    const mockImages: DiscogsImage[] = [
      {
        type: 'primary',
        uri: mockData.image,
        uri150: mockData.image
      }
    ];
    const mockLabels: DiscogsLabel[] = [
      {
        name: 'è¯æ˜Ÿå”±ç‰‡',
        catno: 'CAL-03-1040'
      }
    ];
    const mockFormats: DiscogsFormat[] = [
      {
        name: 'Vinyl',
        descriptions: ['LP', 'Album']
      }
    ];
    const mockExtraArtists1: DiscogsExtraArtist[] = [
      { name: 'å¥§é‡‘å¯¶', role: 'Arranged By' },
      { name: 'æ¥Šä¿ç¾…', role: 'Lyrics By' },
      { name: 'å°æ—æ˜å­', role: 'Music By' }
    ];
    const mockExtraArtists2: DiscogsExtraArtist[] = [
      { name: 'å¡é¾', role: 'Lyrics By' },
      { name: 'é»å°ç”°', role: 'Music By, Arranged By' }
    ];
    const mockExtraArtists3: DiscogsExtraArtist[] = [
      { name: 'ç¾…å»¸', role: 'Arranged By' },
      { name: 'æ—æŒ¯å¼·', role: 'Lyrics By' },
      { name: 'å¤§é‡å…‹å¤«', role: 'Music By' }
    ];
    const mockExtraArtists4: DiscogsExtraArtist[] = [
      { name: 'é»ƒéœ‘', role: 'Lyrics By' },
      { name: 'é¡§å˜‰ç…‡', role: 'Music By, Arranged By' }
    ];
    const mockExtraArtists5: DiscogsExtraArtist[] = [
      { name: 'ç¾…å»¸', role: 'Arranged By' },
      { name: 'æ½˜å‰æº', role: 'Lyrics By' },
      { name: 'Motoaki Masuo', role: 'Music By' }
    ];
    const mockExtraArtists6: DiscogsExtraArtist[] = [
      { name: 'è¶™å¢ç†¹', role: 'Arranged By' },
      { name: 'å°ç¾', role: 'Lyrics By' },
      { name: 'è°·æ‘æ–°å¸', role: 'Music By' }
    ];
    const mockExtraArtists7: DiscogsExtraArtist[] = [
      { name: 'Nanba Hiroyuki', role: 'Arranged By' },
      { name: 'æ—æŒ¯å¼·', role: 'Lyrics By' },
      { name: 'æ²¢æ‘æ‹“äºŒ', role: 'Music By' }
    ];
    const mockExtraArtists8: DiscogsExtraArtist[] = [
      { name: 'å§šå¿—æ¼¢', role: 'Arranged By' },
      { name: 'Leslie', role: 'Lyrics By' },
      { name: 'æ—å“²å¸', role: 'Music By' }
    ];
    const mockExtraArtists9: DiscogsExtraArtist[] = [
      { name: 'è˜‡å¾·è¯', role: 'Arranged By' },
      { name: 'æ—æŒ¯å¼·', role: 'Lyrics By' },
      { name: 'Annie', role: 'Music By' }
    ];
    const mockExtraArtists10: DiscogsExtraArtist[] = [
      { name: 'æœè‡ªæŒ', role: 'Arranged By' },
      { name: 'å¡é¾', role: 'Lyrics By' },
      { name: 'Justin Peters, Steve Davis', role: 'Music By' }
    ];
    
    const mockTracklist: DiscogsTrack[] = [
      {
        position: 'A1',
        title: 'è¿·æƒ‘æˆ‘',
        duration: '4:22',
        extraartists: mockExtraArtists1
      },
      {
        position: 'A2',
        title: 'æƒ…åˆ°æ¿ƒæ™‚',
        duration: '3:56',
        extraartists: mockExtraArtists2
      },
      {
        position: 'A3',
        title: 'éš±èº«äºº',
        duration: '3:38',
        extraartists: mockExtraArtists3
      },
      {
        position: 'A4',
        title: 'ç•¶å¹´æƒ…',
        duration: '4:15',
        extraartists: mockExtraArtists4
      },
      {
        position: 'A5',
        title: 'æ„›çš„æ±ºæ“‡',
        duration: '4:11',
        extraartists: mockExtraArtists5
      },
      {
        position: 'B1',
        title: 'æœ‰èª°å…±é³´',
        duration: '3:53',
        extraartists: mockExtraArtists6
      },
      {
        position: 'B2',
        title: 'çƒˆç«é‚Šç·£',
        duration: '3:38',
        extraartists: mockExtraArtists7
      },
      {
        position: 'B3',
        title: 'æ„›ç«',
        duration: '4:29',
        extraartists: mockExtraArtists8
      },
      {
        position: 'B4',
        title: 'Crazy Rock',
        duration: '4:14',
        extraartists: mockExtraArtists9
      },
      {
        position: 'B5',
        title: 'Miracle',
        duration: '3:51',
        extraartists: mockExtraArtists10
      }
    ];

    const mockReleaseExtraArtists: DiscogsExtraArtist[] = [
      { name: 'åŠ‰åŸ¹åŸº', role: 'Art Direction' },
      { name: 'æéŸ»æš, é™³æ¨¹ç™¼', role: 'Design' },
      { name: 'é»å°ç”°, é‚±å¾·æ', role: 'Mixed By' },
      { name: 'å­«æ·‘èˆˆ', role: 'Photography By' },
      { name: 'å¼µåœ‹æ¦®, é»å°ç”°', role: 'Producer' },
      { name: 'é‚±å¾·æ', role: 'Recorded By' }
    ];

    const mockCompanies: DiscogsCompany[] = [
      { name: 'Capital Artists Ltd.', entity_type_name: 'Phonographic Copyright (p)' },
      { name: 'Capital Artists Ltd.', entity_type_name: 'Copyright (c)' }
    ];

    this.recordDetail = {
      id: parseInt(this.recordId),
      title: mockData.title,
      artists: mockArtists,
      images: mockImages,
      labels: mockLabels,
      formats: mockFormats,
      country: 'USA',
      released: mockData.year,
      genres: mockData.genres,
      styles: mockData.genres,
      tracklist: mockTracklist,
      extraartists: mockReleaseExtraArtists,
      companies: mockCompanies
    };
  }

  // è¿”å›ä¸Šä¸€é 
  private goBack() {
    router.back();
  }

  // åˆ‡æ›æ”¶è—ç‹€æ…‹
  private async toggleFavorite() {
    console.log('=== toggleFavorite å¼€å§‹ ===');
    console.log('å½“å‰æ”¶è—çŠ¶æ€:', this.isFavorite);
    console.log('å”±ç‰‡ID:', this.recordId);

    // é˜²æ­¢é‡å¤ç‚¹å‡»
    if (this.isProcessingFavorite) {
      console.log('æ­£åœ¨å¤„ç†æ”¶è—æ“ä½œï¼Œå¿½ç•¥é‡å¤ç‚¹å‡»');
      return;
    }

    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    const isLoggedIn = await this.authService.isLoggedIn();
    if (!isLoggedIn) {
      console.log('ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•æ”¶è—');
      // TODO: æ˜¾ç¤ºç™»å½•æç¤ºæˆ–è·³è½¬åˆ°ç™»å½•é¡µé¢
      return;
    }

    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    const currentUser = await this.authService.getCurrentUser();
    console.log('ç”¨æˆ·ä¿¡æ¯è¯¦ç»†å†…å®¹:', JSON.stringify(currentUser, null, 2));
    console.log('ç”¨æˆ·ID:', currentUser?.id);
    console.log('ç”¨æˆ·IDç±»å‹:', typeof currentUser?.id);
    if (!currentUser?.id) {
      console.log('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
      return;
    }

    // æ£€æŸ¥å”±ç‰‡è¯¦æƒ…æ˜¯å¦å·²åŠ è½½
    if (!this.recordDetail) {
      console.log('å”±ç‰‡è¯¦æƒ…æœªåŠ è½½ï¼Œæ— æ³•æ”¶è—');
      return;
    }

    this.isProcessingFavorite = true;

    try {
      if (this.isFavorite) {
        // å–æ¶ˆæ”¶è—
        console.log('æ‰§è¡Œå–æ¶ˆæ”¶è—æ“ä½œ');
        const result = await this.favoriteService.removeFavorite(currentUser.id, parseInt(this.recordId));
        
        if (result.success) {
          this.isFavorite = false;
          console.log('å–æ¶ˆæ”¶è—æˆåŠŸ');
        } else {
          console.error('å–æ¶ˆæ”¶è—å¤±è´¥:', result.message);
        }
      } else {
        // æ·»åŠ æ”¶è—
        console.log('æ‰§è¡Œæ·»åŠ æ”¶è—æ“ä½œ');
        
        // æ„é€ æ”¶è—è¯·æ±‚æ•°æ®
        const favoriteRequest: FavoriteRequest = {
          userId: currentUser.id,
          recordId: parseInt(this.recordId),
          recordData: {
            title: this.recordDetail.title ?? '',
            artist: this.recordDetail.artists?.map(artist => artist.name).join(', ') ?? '',
            image: this.recordDetail.images?.[0]?.uri ?? '',
            year: this.recordDetail.year?.toString() ?? '',
            genres: this.recordDetail.genres ?? [],
            formats: this.recordDetail.formats?.map(format => format.name) ?? []
          }
        };

        console.log('æ”¶è—è¯·æ±‚æ•°æ®:', favoriteRequest);

        const result = await this.favoriteService.addFavorite(favoriteRequest);
        
        if (result.success) {
          this.isFavorite = true;
          console.log('æ·»åŠ æ”¶è—æˆåŠŸ');
        } else {
          console.error('æ·»åŠ æ”¶è—å¤±è´¥:', result.message);
        }
      }
    } catch (error) {
      console.error('æ”¶è—æ“ä½œå¼‚å¸¸:', error);
    } finally {
      this.isProcessingFavorite = false;
    }
  }

  // æ£€æŸ¥æ”¶è—çŠ¶æ€
  private async checkFavoriteStatus() {
    console.log('=== checkFavoriteStatus å¼€å§‹ ===');
    
    try {
      // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    const isLoggedIn = await this.authService.isLoggedIn();
      if (!isLoggedIn) {
        console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè®¾ç½®æ”¶è—çŠ¶æ€ä¸ºfalse');
        this.isFavorite = false;
        return;
      }

      // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
      const currentUser = await this.authService.getCurrentUser();
      if (!currentUser?.id || !this.recordId) {
        console.log('ç”¨æˆ·ä¿¡æ¯æˆ–å”±ç‰‡IDæ— æ•ˆ');
        this.isFavorite = false;
        return;
      }

      console.log('æ£€æŸ¥æ”¶è—çŠ¶æ€ - userId:', currentUser.id, 'recordId:', this.recordId);

      // æŸ¥è¯¢æ”¶è—çŠ¶æ€
      const statusResult = await this.favoriteService.checkFavoriteStatus(currentUser.id, parseInt(this.recordId));
      this.isFavorite = statusResult.isFavorite;
      
      console.log('æ”¶è—çŠ¶æ€æŸ¥è¯¢ç»“æœ:', this.isFavorite);
    } catch (error) {
      console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å¼‚å¸¸:', error);
      this.isFavorite = false;
    }
  }

  // æ ¼å¼åŒ–ç™¼è¡Œæ—¥æœŸ
  private formatReleaseDate(dateStr?: string): string {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('zh-TW', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  build() {
    Column() {
      // é ‚éƒ¨æ¨™é¡Œæ¬„
      Row() {
        Image($r('app.media.arrow_back'))
          .width(24)
          .height(24)
          .fillColor(this.textPrimary)
          .onClick(() => {
            this.goBack();
          })

        Text('å”±ç‰‡ä¿¡æ¯')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.textPrimary)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // ä½”ä½ç¬¦ä¿æŒå°ç¨±
        Row().width(24).height(24)
      }
      .width('100%')
      .height(60)
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor(this.bgColor)

      // ä¸»è¦å…§å®¹å€åŸŸ
      if (this.isLoading) {
        // è¼‰å…¥ä¸­ç‹€æ…‹
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color(this.primaryColor)
          
          Text('è½½å…¥ä¸­...')
            .fontSize(16)
            .fontColor(this.textSecondary)
            .margin({ top: 16 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else if (!this.recordDetail) {
        // éŒ¯èª¤ç‹€æ…‹
        Column() {
          Image($r('app.media.error'))
            .width(60)
            .height(60)
            .fillColor(this.textSecondary)
          
          Text('è½½å…¥å¤±è´¥')
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.textPrimary)
            .margin({ top: 16 })
          
          Text('ç½‘ç»œå¥½åƒæ€ªæ€ªçš„')
            .fontSize(14)
            .fontColor(this.textSecondary)
            .margin({ top: 8 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        // è©³æƒ…å…§å®¹
        Scroll() {
          Column({ space: 20 }) {
            // å”±ç‰‡å°é¢å’ŒåŸºæœ¬ä¿¡æ¯
            Column({ space: 16 }) {
              // å°é¢åœ–ç‰‡
              if (this.recordDetail.images && this.recordDetail.images.length > 0) {
                Image(this.recordDetail.images[this.selectedImageIndex].uri)
                  .width(200)
                  .height(200)
                  .borderRadius(12)
                  .objectFit(ImageFit.Cover)
                  .alt($r('app.media.placeholder_album'))
              } else {
                Column()
                  .width(200)
                  .height(200)
                  .borderRadius(12)
                  .backgroundColor(this.secondaryColor)
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
              }

              // æ¨™é¡Œå’Œè—è¡“å®¶
              Column({ space: 8 }) {
                Text(this.recordDetail.title)
                  .fontSize(24)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.textPrimary)
                  .textAlign(TextAlign.Center)
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })

                if (this.recordDetail.artists && this.recordDetail.artists.length > 0) {
                  Text(this.recordDetail.artists.map(artist => artist.name).join(', '))
                    .fontSize(18)
                    .fontColor(this.primaryColor)
                    .textAlign(TextAlign.Center)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
              }
              .width('100%')

              // æ”¶è—æŒ‰é’®
              Button() {
                Row({ space: 8 }) {
                  if (this.isProcessingFavorite) {
                    LoadingProgress()
                      .width(16)
                      .height(16)
                      .color(this.textSecondary)
                  } else {
                    Image($r('app.media.ic_favorite'))
                      .width(20)
                      .height(20)
                      .fillColor(this.isFavorite ? '#ff4757' : this.textSecondary)
                  }
                  
                  Text(this.isProcessingFavorite ? 'å¤„ç†ä¸­...' : (this.isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—'))
                    .fontSize(16)
                    .fontColor(this.isFavorite ? '#ff4757' : this.textPrimary)
                }
              }
              .width(120)
              .height(40)
              .backgroundColor(this.isFavorite ? 'rgba(255, 71, 87, 0.1)' : this.cardBgColor)
              .borderRadius(20)
              .border({
                width: 1,
                color: this.isFavorite ? '#ff4757' : this.textSecondary
              })
              .enabled(!this.isProcessingFavorite) // å¤„ç†ä¸­æ—¶ç¦ç”¨æŒ‰é’®
              .onClick(() => {
                this.toggleFavorite();
              })
            }
            .width('100%')
            .alignItems(HorizontalAlign.Center)

            // åŸºæœ¬ä¿¡æ¯å¡ç‰‡
            Column({ space: 16 }) {
              // Label
              if (this.recordDetail.labels && this.recordDetail.labels.length > 0) {
                Column({ space: 8 }) {
                  Text('Label:')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.textPrimary)
                  
                  ForEach(this.recordDetail.labels, (label: DiscogsLabel) => {
                    Text(`${label.name}${label.catno ? ` â€“ ${label.catno}` : ''}`)
                      .fontSize(14)
                      .fontColor(this.textSecondary)
                  })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }

              // Format
              if (this.recordDetail.formats && this.recordDetail.formats.length > 0) {
                Column({ space: 8 }) {
                  Text('Format:')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.textPrimary)
                  
                  ForEach(this.recordDetail.formats, (format: DiscogsFormat) => {
                    Text(`${format.name}${format.descriptions ? ', ' + format.descriptions.join(', ') : ''}`)
                      .fontSize(14)
                      .fontColor(this.textSecondary)
                  })
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }

              // Country
              if (this.recordDetail.country) {
                Column({ space: 8 }) {
                  Text('Country:')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.textPrimary)
                  
                  Text(this.recordDetail.country)
                    .fontSize(14)
                    .fontColor(this.textSecondary)
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }

              // Released
              if (this.recordDetail.released) {
                Column({ space: 8 }) {
                  Text('Released:')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.textPrimary)
                  
                  Text(this.formatReleaseDate(this.recordDetail.released))
                    .fontSize(14)
                    .fontColor(this.textSecondary)
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }

              // Genre
              if (this.recordDetail.genres && this.recordDetail.genres.length > 0) {
                Column({ space: 8 }) {
                  Text('Genre:')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.textPrimary)
                  
                  Text(this.recordDetail.genres.join(', '))
                    .fontSize(14)
                    .fontColor(this.textSecondary)
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }

              // Style
              if (this.recordDetail.styles && this.recordDetail.styles.length > 0) {
                Column({ space: 8 }) {
                  Text('Style:')
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.textPrimary)
                  
                  Text(this.recordDetail.styles.join(', '))
                    .fontSize(14)
                    .fontColor(this.textSecondary)
                }
                .width('100%')
                .alignItems(HorizontalAlign.Start)
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor(this.cardBgColor)
            .borderRadius(12)
            .alignItems(HorizontalAlign.Start)

            // æ›²ç›®åˆ—è¡¨
            if (this.recordDetail.tracklist && this.recordDetail.tracklist.length > 0) {
              Column({ space: 12 }) {
                Text('æ›²ç›®åˆ—è¡¨')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.textPrimary)
                  .width('100%')

                ForEach(this.recordDetail.tracklist, (track: DiscogsTrack) => {
                  Column({ space: 8 }) {
                    Row() {
                      Text(track.position)
                        .fontSize(14)
                        .fontWeight(FontWeight.Bold)
                        .fontColor(this.primaryColor)
                        .width(40)

                      Text(track.title)
                        .fontSize(16)
                        .fontWeight(FontWeight.Medium)
                        .fontColor(this.textPrimary)
                        .layoutWeight(1)
                        .maxLines(2)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })

                      if (track.duration) {
                        Text(track.duration)
                          .fontSize(14)
                          .fontColor(this.textSecondary)
                      }
                    }
                    .width('100%')
                    .alignItems(VerticalAlign.Top)

                    // å‰µä½œäººå“¡ä¿¡æ¯
                    if (track.extraartists && track.extraartists.length > 0) {
                      Column({ space: 4 }) {
                        ForEach(track.extraartists, (artist: DiscogsExtraArtist) => {
                          Text(`${artist.role} â€“ ${artist.name}`)
                            .fontSize(12)
                            .fontColor(this.textSecondary)
                            .width('100%')
                            .margin({ left: 40 })
                        })
                      }
                      .width('100%')
                    }
                  }
                  .width('100%')
                  .padding(12)
                  .backgroundColor(this.cardBgColor)
                  .borderRadius(8)
                })
              }
              .width('100%')
            }

            // è£½ä½œäººå“¡ä¿¡æ¯
            if (this.recordDetail.extraartists && this.recordDetail.extraartists.length > 0) {
              Column({ space: 12 }) {
                Text('åˆ›ä½œäººå‘˜')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.textPrimary)
                  .width('100%')

                Column({ space: 8 }) {
                  ForEach(this.recordDetail.extraartists, (artist: DiscogsExtraArtist) => {
                    Text(`${artist.role} â€“ ${artist.name}`)
                      .fontSize(14)
                      .fontColor(this.textSecondary)
                      .width('100%')
                  })
                }
                .width('100%')
                .padding(16)
                .backgroundColor(this.cardBgColor)
                .borderRadius(12)
              }
              .width('100%')
            }

            // ç‰ˆæ¬Šä¿¡æ¯
            if (this.recordDetail.companies && this.recordDetail.companies.length > 0) {
              Column({ space: 12 }) {
                Text('ç‰ˆæƒä¿¡æ¯')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.textPrimary)
                  .width('100%')

                Column({ space: 8 }) {
                  ForEach(this.recordDetail.companies, (company: DiscogsCompany) => {
                    Text(`${company.entity_type_name} â€“ ${company.name}`)
                      .fontSize(14)
                      .fontColor(this.textSecondary)
                      .width('100%')
                  })
                }
                .width('100%')
                .padding(16)
                .backgroundColor(this.cardBgColor)
                .borderRadius(12)
              }
              .width('100%')
            }
          }
          .padding({ left: 16, right: 16, top: 16, bottom: 100 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }

      // åº•éƒ¨å°èˆªæ¬„
      Row() {
        Column({ space: 4 }) {
          Image($r('app.media.search'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 0 ? this.primaryColor : this.textSecondary)

          Text('æœå”±ç‰‡')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 0 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 0;
          router.pushUrl({ url: 'pages/Index' });
        })

        Column({ space: 4 }) {
          Image($r('app.media.grid'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 1 ? this.primaryColor : this.textSecondary)

          Text('å”±ç‰‡å¢™')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 1 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 1;
          router.pushUrl({ url: 'pages/RecordWall' });
        })

        Column({ space: 4 }) {
          Image($r('app.media.history'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 2 ? this.primaryColor : this.textSecondary)

          Text('æ—¶å…‰æœº')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 2 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 2;
          router.pushUrl({ url: 'pages/TimeMachine' });
        })

        Column({ space: 4 }) {
          Image($r('app.media.person'))
            .width(24)
            .height(24)
            .fillColor(this.currentTab === 3 ? this.primaryColor : this.textSecondary)

          Text('æˆ‘')
            .fontSize(10)
            .fontWeight(FontWeight.Medium)
            .fontColor(this.currentTab === 3 ? this.primaryColor : this.textSecondary)
        }
        .layoutWeight(1)
        .onClick(() => {
          this.currentTab = 3;
          router.pushUrl({ url: 'pages/Profile' });
        })
      }
      .width('100%')
      .height(80)
      .padding({ top: 8, bottom: 8 })
      .backgroundColor('#000000CC')
      .border({ width: { top: 1 }, color: this.secondaryColor + '80' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.bgColor)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.BOTTOM])
  }
}